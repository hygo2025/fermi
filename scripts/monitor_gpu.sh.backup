#!/bin/bash
# Monitor de GPU e Progresso dos Experimentos

clear
echo "================================================================================"
echo "                    MONITOR DE EXPERIMENTOS - GPU RTX 4090"
echo "================================================================================"
echo ""

# Função para encontrar diretório de execução mais recente
get_latest_run_dir() {
    ls -td outputs/results/20*/ 2>/dev/null | head -1
}

# Função para mostrar progresso dos experimentos
show_progress() {
    latest_dir=$(get_latest_run_dir)
    
    if [ -z "$latest_dir" ]; then
        echo "Nenhum experimento em execução ainda."
        echo ""
        return
    fi
    
    echo "Diretório: $latest_dir"
    echo "-------------------------"
    echo ""
    
    # Mostra progresso de cada modelo (últimas linhas dos logs)
    for log in "$latest_dir"*_execution.log 2>/dev/null; do
        if [ -f "$log" ]; then
            model=$(basename "$log" _execution.log)
            echo "Modelo: $model"
            tail -3 "$log" | grep -E "epoch|INFO|Running|Progress|Testing" | sed 's/^/  /' || echo "  Aguardando..."
            echo ""
        fi
    done
    
    # Conta quantos experimentos já foram concluídos
    if [ -f "$latest_dir/raw_results.csv" ]; then
        total_runs=$(tail -n +2 "$latest_dir/raw_results.csv" 2>/dev/null | wc -l)
        echo "Experimentos concluídos: $total_runs"
        echo ""
    fi
}

# Função para mostrar GPU
show_gpu() {
    echo "Status da GPU:"
    echo "--------------"
    nvidia-smi --query-gpu=name,temperature.gpu,utilization.gpu,utilization.memory,memory.used,memory.total --format=csv,noheader,nounits | \
    awk -F', ' '{printf "GPU: %s\nTemp: %s°C | Util: %s%% | VRAM: %s/%s MB\n", $1, $2, $3, $5, $6}'
    echo ""
}

# Loop de monitoramento
while true; do
    clear
    echo "================================================================================"
    echo "                    MONITOR DE EXPERIMENTOS - GPU RTX 4090"
    echo "                          $(date '+%Y-%m-%d %H:%M:%S')"
    echo "================================================================================"
    echo ""
    
    show_gpu
    echo ""
    show_progress
    
    echo "================================================================================"
    echo "Atualizando em 2 segundos... (Ctrl+C para sair)"
    echo "================================================================================"
    
    sleep 2
done
